name: envoy
version: master
summary: C++ front/service proxy
description: |
  Envoy is an L7 proxy and communication bus designed for large modern service
  oriented architectures.

grade: devel
confinement: devmode

build-packages: [binutils, gcc]

apps:
  envoy:
    command: source/exe/envoy
    plugs: [network, network-bind]

parts:
  envoy:
    source: .
    plugin: cmake
    configflags:
      - "-L"
      - "-DENVOY_COTIRE_MODULE_DIR:FILEPATH=$SNAPCRAFT_STAGE/cotire/CMake"
      - "-DENVOY_PROTOBUF_PROTOC:FILEPATH=$SNAPCRAFT_STAGE/bin/protoc"
      - "-DENVOY_SPDLOG_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_LIBEVENT_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_HTTP_PARSER_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_LIGHTSTEP_TRACER_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_NGHTTP2_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_RAPIDJSON_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_GPERFTOOLS_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_TCLAP_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
      - "-DENVOY_GMOCK_INCLUDE_DIR:FILEPATH=$SNAPCRAFT_STAGE/include"
    artifacts:
      - source/exe/envoy
    after:
      - cotire
      - protobuf
      - spdlog
      - libevent
      - http-parser
      - lightstep
      - nghttp2
      - rapidjson
      - gperftools
      - tclap
      - googletest

  cotire:
    source: https://github.com/sakra/cotire/archive/cotire-1.7.8.tar.gz
    plugin: dump
    organize:
      "*": cotire/
    prime:
      - -*

  protobuf:
    source: https://github.com/google/protobuf/releases/download/v3.0.0/protobuf-cpp-3.0.0.tar.gz
    plugin: autotools

  spdlog:
    source: https://github.com/gabime/spdlog/archive/v0.11.0.tar.gz
    plugin: dump
    prime:
      - include
    after: [cotire]

  libevent:
    source: https://github.com/libevent/libevent/releases/download/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz
    plugin: autotools
    configflags:
      - --enable-share=no
      - --disable-libevent-regress
      - --disable-openssl

  http-parser:
    source: https://github.com/nodejs/http-parser/archive/v2.7.0.tar.gz
    plugin: dump
    build: |
      gcc -O2 -c http_parser.c -o http_parser.o
      ar rcs libhttp_parser.a http_parser.o
    install: |
      mkdir $SNAPCRAFT_PART_INSTALL/lib/
      cp libhttp_parser.a $SNAPCRAFT_PART_INSTALL/lib/
      mkdir $SNAPCRAFT_PART_INSTALL/include
      cp http_parser.h $SNAPCRAFT_PART_INSTALL/include/

  lightstep:
    source: https://github.com/lightstep/lightstep-tracer-cpp/releases/download/v0_19/lightstep-tracer-cpp-0.19.tar.gz
    plugin: autotools
    configflags:
      - --disable-grpc
      - --enable-shared=no
      - protobuf_CFLAGS="-I$SNAPCRAFT_STAGE/include"
      - protobuf_LIBS="-L$SNAPCRAFT_STAGE/lib -lprotobuf"
    after: [protobuf]

  nghttp2:
    source: https://github.com/nghttp2/nghttp2/releases/download/v1.14.1/nghttp2-1.14.1.tar.gz
    plugin: autotools
    configflags:
      - --enable-shared=no
      - --enable-lib-only

  rapidjson:
    source: https://github.com/miloyip/rapidjson/archive/v1.1.0.tar.gz
    plugin: dump
    stage:
      - include
      - bin
    after: [spdlog]

  gperftools:
    source: https://github.com/gperftools/gperftools/releases/download/gperftools-2.5/gperftools-2.5.tar.gz
    plugin: autotools
    configflags:
      - --enable-shared=no
      - --enable-frame-pointers

  tclap:
    source: https://sourceforge.net/projects/tclap/files/tclap-1.2.1.tar.gz/download
    source-type: tar
    plugin: dump
    stage:
      - include/tclap
    after: [spdlog]

  googletest:
    source: https://github.com/google/googletest/archive/release-1.8.0.tar.gz
    plugin: cmake
    prime:
      - -*
